# Integration Examples

Real-world examples showing different integration patterns, complete working plugins, and advanced validation scenarios for the Block Accessibility Checks plugin.

## Table of Contents

1. [External Plugin Integration](#external-plugin-integration)
2. [Custom Block Validation](#custom-block-validation)
3. [Advanced Validation Patterns](#advanced-validation-patterns)
4. [Complete Working Example](#complete-working-example)
5. [Advanced Patterns](#advanced-patterns)

## External Plugin Integration

The Block Accessibility Checks plugin provides seamless integration for external plugins with custom blocks. External plugins automatically get their own settings page and full integration with the validation system.

### Automatic Settings Integration

When you register checks with `type: 'settings'`, your external plugin automatically:

1. **Gets a dedicated settings page** under the "Block Checks" menu
2. **Provides individual check control** - each check can be set to Error, Warning, or Disabled
3. **Integrates with the admin interface** - settings are saved and applied immediately
4. **Shows in the block editor** - validation feedback appears in real-time

### Example: External Plugin Integration

```php
// Register checks for your custom block
add_action('ba11yc_register_checks', 'my_plugin_register_checks');

function my_plugin_register_checks($registry) {
    // This check will appear in your plugin's settings page
    $registry->register_check('my-plugin/card-block', 'content_required', [
        'error_msg'   => __('Card content is required.', 'my-plugin'),
        'warning_msg' => __('Card content is recommended.', 'my-plugin'),
        'description' => __('Content validation for card blocks.', 'my-plugin'),
        'type'        => 'settings', // Appears in admin settings
    ]);

    // This check is forced as an error (bypasses settings)
    $registry->register_check('my-plugin/card-block', 'link_required', [
        'error_msg'   => __('Card link is required.', 'my-plugin'),
        'description' => __('Link validation for card blocks.', 'my-plugin'),
        'type'        => 'error', // Always an error, no settings control
    ]);
}
```

### JavaScript Validation

```javascript
import { addFilter } from '@wordpress/hooks';

addFilter(
    'ba11yc.validateBlock',
    'my-plugin/validation',
    (isValid, blockType, attributes, checkName, rule) => {
        if (blockType !== 'my-plugin/card-block') {
            return isValid;
        }

        switch (checkName) {
            case 'content_required':
                return !!(attributes.content && attributes.content.trim());
            case 'link_required':
                return !!(attributes.link && attributes.link.trim());
            default:
                return isValid;
        }
    }
);
```

## Custom Block Validation

### Testimonial Block Example

Here's a complete example showing how to integrate a custom testimonial block:

#### File Structure

```
my-testimonial-block/
├── my-testimonial-block.php (main plugin file)
├── includes/
│   └── accessibility-integration.php
├── src/
│   ├── accessibility-checks.js
│   └── my-testimonial-block/
│       ├── edit.js
│       └── block.json
└── build/ (generated by build process)
```

#### PHP Registration (includes/accessibility-integration.php)

```php
<?php
/**
 * Block Accessibility Checks Integration
 */

// Prevent direct access
if (!defined('ABSPATH')) {
	exit;
}

/**
 * Register accessibility checks for testimonial block
 * Only metadata - all validation logic is in JavaScript
 */
function my_testimonial_register_accessibility_checks($registry) {
	// Required author name
	$registry->register_check('external-block/my-testimonial-block', 'author_required', [
		'error_msg'   => __('Author name is required for testimonials.', 'my-testimonial-block'),
		'warning_msg' => __('Author name is recommended for testimonials.', 'my-testimonial-block'),
		'description' => __('Author attribution is important for testimonial credibility.', 'my-testimonial-block'),
		'type'        => 'settings', // Uses admin settings by default
	]);

	// Required content
	$registry->register_check('external-block/my-testimonial-block', 'content_required', [
		'error_msg'   => __('Testimonial content cannot be empty.', 'my-testimonial-block'),
		'description' => __('Empty testimonials provide no value to users.', 'my-testimonial-block'),
		'type'        => 'error', // Forced as error, bypasses settings
	]);

	// Heading structure
	$registry->register_check('external-block/my-testimonial-block', 'heading_structure', [
		'error_msg'   => __('If using a heading, ensure it follows proper heading hierarchy.', 'my-testimonial-block'),
		'warning_msg' => __('Heading structure should follow proper hierarchy.', 'my-testimonial-block'),
		'description' => __('Proper heading structure improves accessibility for screen reader users.', 'my-testimonial-block'),
		'type'        => 'warning', // Forced as warning, bypasses settings
	]);
}

/**
 * Enqueue accessibility checks JavaScript
 */
function my_testimonial_enqueue_accessibility_assets() {
	wp_enqueue_script(
		'my-testimonial-accessibility-checks',
		plugins_url('build/accessibility-checks.js', dirname(__FILE__)),
		['wp-hooks', 'wp-i18n', 'block-accessibility-script'],
		'1.0.0',
		true
	);
}

// Hook into Block Accessibility Checks when it's ready
add_action('ba11yc_register_checks', 'my_testimonial_register_accessibility_checks');

// Enqueue our accessibility checks script in the block editor
add_action('enqueue_block_editor_assets', 'my_testimonial_enqueue_accessibility_assets');
```

#### Main Plugin File Integration

```php
<?php
/**
 * Plugin Name: My Testimonial Block
 */

// Plugin initialization code here...

/**
 * Load accessibility integration when Block Accessibility Checks is ready
 */
function my_testimonial_load_accessibility_integration() {
	if (function_exists('BlockAccessibility\\BlockChecksRegistry::get_instance')) {
		require_once plugin_dir_path(__FILE__) . 'includes/accessibility-integration.php';
	}
}
add_action('ba11yc_ready', 'my_testimonial_load_accessibility_integration');
```

#### JavaScript Validation Implementation (src/accessibility-checks.js)

```javascript
/**
 * Testimonial Block Accessibility Checks
 *
 * Integrates with the Block Accessibility Checks plugin validation system.
 * All validation logic is handled in JavaScript for real-time feedback.
 */

import { addFilter } from '@wordpress/hooks';
import { __ } from '@wordpress/i18n';

/**
 * Register validation logic for testimonial block using the unified hook system
 */
addFilter(
	'ba11yc.validateBlock',
	'my-testimonial-block/validation',
	(isValid, blockType, attributes, checkName, rule) => {
		// Only handle our block type
		if (blockType !== 'external-block/my-testimonial-block') {
			return isValid;
		}

		// Run validation based on check name
		switch (checkName) {
			case 'author_required':
				// Return true if valid, false if invalid
				return !!(attributes.author && attributes.author.trim());

			case 'content_required':
				// Return true if valid, false if invalid
				return !!(attributes.content && attributes.content.trim());

			case 'heading_structure':
				// If headingText exists, it should have content
				if (attributes.headingText !== undefined && attributes.headingText !== null) {
					return !!(attributes.headingText && attributes.headingText.trim());
				}
				// No heading is fine (valid)
				return true;

			default:
				// Unknown check, let other filters handle it
				return isValid;
		}
	}
);
```

## Advanced Validation Patterns

### Conditional Check Registration

```php
function conditionally_register_checks($registry) {
	// Only register for certain post types
	if (get_post_type() === 'product') {
		$registry->register_check('core/image', 'product_image_requirements', [
			'error_msg' => __('Product images must have descriptive alt text.', 'my-plugin'),
			'type' => 'error'
		]);
	}
}
add_action('ba11yc_register_checks', 'conditionally_register_checks');
```

### Dynamic Check Configuration

```php
function modify_check_configuration($check_args, $block_type, $check_name) {
	// Make certain checks warnings instead of errors for specific roles
	if (!current_user_can('manage_options') && $check_args['type'] === 'error') {
		if (in_array($check_name, ['optional_accessibility_check'])) {
			$check_args['type'] = 'warning';
		}
	}

	return $check_args;
}
add_filter('ba11yc_check_args', 'modify_check_configuration', 10, 3);
```

### Custom Result Processing

```php
function process_custom_check_results($results, $block_type, $attributes, $content) {
	// Add contextual information to results
	foreach ($results as &$result) {
		if ($result['check_name'] === 'heading_hierarchy') {
			$result['context'] = [
				'post_type' => get_post_type(),
				'current_user_role' => wp_get_current_user()->roles[0] ?? 'subscriber'
			];
		}
	}

	return $results;
}
add_filter('ba11yc_block_check_results', 'process_custom_check_results', 10, 4);
```

### Block Attribute Preprocessing

```php
function preprocess_block_attributes($attributes, $block_type, $content) {
	// Normalize attributes before validation
	if ($block_type === 'core/image') {
		// Ensure alt attribute exists
		if (!isset($attributes['alt'])) {
			$attributes['alt'] = '';
		}

		// Clean up alt text
		$attributes['alt'] = trim($attributes['alt']);
	}

	return $attributes;
}
add_filter('ba11yc_block_attributes', 'preprocess_block_attributes', 10, 3);
```

## Advanced JavaScript Integration

### Advanced JavaScript validation with multiple rules

```javascript
// Advanced JavaScript validation with multiple rules
function advancedBlockValidation(block) {
	const { name, attributes } = block;
	const validationRules = window.BlockAccessibilityChecks?.validationRules || {};
	const blockRules = validationRules[name] || {};

	const errors = [];
	const warnings = [];

	// Process all rules and collect results by severity
	Object.entries(blockRules).forEach(([checkId, rule]) => {
		if (!rule.enabled) return;

		const isValid = performValidation(checkId, attributes, rule);

		if (!isValid) {
			const result = {
				checkId,
				message: rule.message,
				type: rule.type,
				priority: rule.priority || 10,
			};

			if (rule.type === 'error') {
				errors.push(result);
			} else {
				warnings.push(result);
			}
		}
	});

	// Return highest severity issue first
	if (errors.length > 0) {
		const highestPriorityError = errors.sort((a, b) => a.priority - b.priority)[0];
		return {
			isValid: false,
			mode: 'error',
			clientId: block.clientId,
			name: block.name,
			message: highestPriorityError.message,
			allIssues: [...errors, ...warnings],
		};
	}

	if (warnings.length > 0) {
		const highestPriorityWarning = warnings.sort((a, b) => a.priority - b.priority)[0];
		return {
			isValid: false,
			mode: 'warning',
			clientId: block.clientId,
			name: block.name,
			message: highestPriorityWarning.message,
			allIssues: warnings,
		};
	}

	return { isValid: true };
}

function performValidation(checkId, attributes, rule) {
	// Custom validation logic here
	switch (checkId) {
		case 'complex_validation':
			return validateComplexRule(attributes, rule);
		default:
			return true;
	}
}
```

### Complex Validation Examples

#### Image Alt Text Validation

```javascript
function validateImageAlt(attributes) {
	// Check if image is decorative
	if (attributes.isDecorative) {
		return true; // Valid - decorative images don't need alt text
	}

	// Check if alt text exists
	if (!attributes.alt || !attributes.alt.trim()) {
		return false; // Invalid - missing alt text
	}

	// Check if alt text is meaningful (not just filename)
	const alt = attributes.alt.toLowerCase();
	const filenamePatterns = ['.jpg', '.png', '.gif', '.webp', 'img_', 'image'];

	for (const pattern of filenamePatterns) {
		if (alt.includes(pattern)) {
			return false; // Invalid - looks like filename
		}
	}

	return true; // Valid
}
```

#### Heading Hierarchy Validation

```javascript
function validateHeadingHierarchy(attributes, content) {
	const level = attributes.level || 2;
	
	// Get all headings in the content
	const headingMatches = content.match(/<h[1-6][^>]*>/g) || [];
	const headingLevels = headingMatches.map(match => {
		const levelMatch = match.match(/<h([1-6])/);
		return levelMatch ? parseInt(levelMatch[1]) : 1;
	});

	// Check for skipped levels
	for (let i = 0; i < headingLevels.length - 1; i++) {
		const current = headingLevels[i];
		const next = headingLevels[i + 1];
		
		if (next > current + 1) {
			return false; // Invalid - skipped heading level
		}
	}

	return true; // Valid
}
```

#### Content Length Validation

```javascript
function validateContentLength(attributes, rule) {
	const content = attributes.content || '';
	const maxLength = rule.maxLength || 500;
	const minLength = rule.minLength || 10;

	// Check minimum length
	if (content.length < minLength) {
		return false;
	}

	// Check maximum length
	if (content.length > maxLength) {
		return false;
	}

	return true;
}
```

## Complete Working Example

For a complete working example of external plugin integration, see the [Block Check Integration Example](https://github.com/troychaplin/block-check-integration-example) plugin. This plugin demonstrates:

- Complete PHP and JavaScript integration
- Multiple validation checks with different severity levels
- Real-time visual feedback in the block editor
- Settings page integration
- Proper asset management and dependencies
- Advanced validation patterns
- Error handling and debugging

### Key Features of the Example Plugin

1. **Multiple Block Types**: Demonstrates validation for different block types
2. **Severity Levels**: Shows how to use different check types (error, warning, settings)
3. **Real-time Feedback**: Visual indicators and messages appear instantly
4. **Settings Integration**: Admin settings control check behavior
5. **Performance Optimization**: Efficient validation patterns
6. **Error Handling**: Proper error handling and debugging tools

## Advanced Patterns

### Performance Optimization

```javascript
// Cache expensive operations
const validationCache = new Map();

function optimizedValidation(blockType, attributes, checkName) {
	const cacheKey = `${blockType}-${checkName}-${JSON.stringify(attributes)}`;
	
	if (validationCache.has(cacheKey)) {
		return validationCache.get(cacheKey);
	}

	// Perform expensive validation...
	const result = performExpensiveValidation(attributes);
	
	validationCache.set(cacheKey, result);
	return result;
}
```

### Conditional Validation

```javascript
function conditionalValidation(blockType, attributes, checkName, rule) {
	// Skip validation for certain conditions
	if (attributes.isPreview) {
		return true; // Skip validation in preview mode
	}

	// Apply different validation based on context
	if (attributes.context === 'admin') {
		return validateForAdmin(attributes, checkName);
	} else {
		return validateForPublic(attributes, checkName);
	}
}
```

### Custom Error Messages

```javascript
function getCustomErrorMessage(attributes, rule) {
	// Generate contextual error messages
	const fieldName = rule.fieldName || 'field';
	const currentValue = attributes[fieldName] || '';
	
	if (!currentValue) {
		return `${fieldName} is required for accessibility compliance.`;
	}
	
	if (currentValue.length < rule.minLength) {
		return `${fieldName} must be at least ${rule.minLength} characters long.`;
	}
	
	return rule.message || 'Validation failed.';
}
```

---

For more examples and implementation details, see the [Working Example Plugin](https://github.com/troychaplin/block-check-integration-example) and the [API Reference](api-reference.md) for complete technical documentation. 